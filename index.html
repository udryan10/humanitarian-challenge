<!--
  inex.html
  Main page for app. Separate up separate pages using jquery mobile
-->

<!-- todo: check to make sure cookies are enabled for device -->
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src= "./javascript/jquery.cookie.js"></script>
  <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
</head>

<body>
<script language = "javascript" type = "text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40843604-1', 'cfh.dyndns.org');
  ga('send', 'pageview');

var selectedItems = new Array();
var pick2 = 0;
var imczar = 0;
var imczarintervalid;
var redrawsRemaining;

$(document).ready(function(){

  if(!$.cookie('cfh_cookie')){
    //new player - need to turn on code enter form
    $(location).attr('href','index.html#register');
  }
  else { //this is a returning player
    //populate gameinfo div with player id and game id
    $('#main_page_header').html(jQuery.parseJSON($.cookie('cfh_cookie')).game_uid);
    //setup our czar and black card timer checks
    $(location).attr('href','index.html#main');
    setInterval("czjarCheck()", 2000);
    setInterval("blackCardCheck()", 2000);
    setInterval("update_score()", 3000);
    setInterval("redraw_check()", 3000);
  }
});

function redraw_check()
{

    $.getJSON("redraw_num_check.php", { "game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid, "uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid }, function(data){
         redrawsRemaining = data.redraws_remaining;
         $("#redraws_remaining").html(redrawsRemaining);
         
    });

}
function submit_Picks()
{
  //if czar, no submit
  if(pick2 == "0" && selectedItems.length == 1)
  {
    if($('#submit_picks_button').hasClass('ui-disabled'))
    {
      $("#submit_picks_button").removeClass('ui-disabled');
    }
    //$('#submit_picks_button').show();	
  }
  else if (pick2 == "1" && selectedItems.length == 2)
  {
    if($('#submit_picks_button').hasClass('ui-disabled'))
    {
      $("#submit_picks_button").removeClass('ui-disabled');
    }
    //$('#submit_picks_button').show(); 
  }
  else
  {
    if(!$('#submit_picks_button').hasClass('ui-disabled'))
    {
      $("#submit_picks_button").addClass('ui-disabled');
    }
    //$('#submit_picks_button').hide();
  }
}

function card_select(element)
{
  if(imczar == 1) { return; } //if you are czar, cant select cards to submit

  if($("td[name=black_card_contents]").attr('id') == 'black_id_-1') { return; } //if there is no black card, can't select any white cards

  if ($(element).attr('id') == -1){ return;} //this is a blank white card, return

  if(selectedItems.length == 0)
  {
    selectedItems.push(element.id);
    $(element).css("background-color","#868686");
    submit_Picks();
  }
  else
  {
    var x;
    var inTest = 0;
    for (x in selectedItems)
    {
      if(selectedItems[x] == element.id) //if we find a card, we are unselecting it
      {
        selectedItems.splice(inTest,1);
	$(element).css("background-color","#f2f2f2");
	submit_Picks();
      }
      inTest++;
    }

    if(inTest == selectedItems.length) //no card foudn, we are selecting it
    {
      selectedItems.push(element.id);
      $(element).css("background-color","#868686");
      submit_Picks();
    }
  }
}

function redraw_submit()
{
  if($("#redraw_input").val() == '' || isNaN($("#redraw_submit").val()))
  {
    alert('value must be a valid integer');
  }
  else
  {
    $.mobile.changePage('create_game.php', {
      type: "post",
      data: $("#redraw_input").serialize(), 
    });
  }
}

function submitInfo()
{
  if($("#game_id_input").val() == '' || $("#name_input").val() == '')
  {
    alert('please include all fields');
  }
  else
  {
    $.getJSON("register_user.php", { "player_name":$("#name_input").val(), "code_box":$("#game_id_input").val() }, function(data){
  
      if(data.returnstatus == 'success')
      {
        var cookieString = '{"player_uid" : "'+ data.player_uid + '","game_uid": "'+ data.game_uid +'"}';
  
        $.cookie('cfh_cookie', cookieString , { expires: 1, path: '/' });
  	
        $('#main_page_header').html(jQuery.parseJSON($.cookie('cfh_cookie')).game_uid); 
        $(location).attr('href','index.html#main');
        setInterval("czjarCheck()", 2000);	
        setInterval("blackCardCheck()", 2000);
        setInterval("update_score()", 3000);
        setInterval("redraw_check()", 3000);
      }
      else if (data.returnstatus == 'error')
      {
        $('#code_enter_error_text').html(data.returnmessage);
      }
    });
  }
}

function blackCardCheck()
{
  $.getJSON("black_card_check.php",{"game_id": jQuery.parseJSON($.cookie('cfh_cookie')).game_uid}, function (data){
    pick2 = data.pick2;
    //TODO: in html use name and set card id to either -1 or cardid. when user select_white_card ensure black_card is not -1
    $("td[name=black_card_contents]").html(data.cardtext);
  
    $("td[name=black_card_contents]").attr('id', "black_id_" +data.cardid);	
  });
}

function gatherSubmits()
{
  $.getJSON("gather_submits.php", {"game_id": jQuery.parseJSON($.cookie('cfh_cookie')).game_uid}, function(data){
         
    if(data.allsubmitted == 'true')
    {
      $("#submitted_player_count").html(0);
  
      var buildhtml = "<table border = 1 style = 'width: 100%'>";
      jQuery.each(data.submissions[0],function(index,itemData) {
  
        //buildhtml +=  "<tr><td  onclick = 'pick_winner(this)' id =" + index + ">" + itemData.slice(0,-1) + "</td></tr>";
        buildhtml +=  "<tr><td style = 'padding: 10px; width: 40%'>" + itemData.slice(0,-1) + "</td><td style = 'padding: 10px;width: 60%;' ><form><a href = '#' onclick = 'pick_winner(this)' data-role='button' id='" + index + "'> Select </a></form>" + "</td></tr>";
      }); 
  
      buildhtml += "</table>";
      $("#submitted_display").html(buildhtml).trigger("create");
      clearInterval(imczarintervalid);
  
    }
    else
    { 
      $("#submitted_player_count").html(data.numneedingtosubmit); 
    }
  }); 
}

function czjarCheck()
{
  $.getJSON("czarCheck.php", {"uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid},function(data){
    if(data.isczar == "1")//this user is activley the card czar
    {
      if(imczar == 0)
      {
        imczarintervalid = setInterval("gatherSubmits()", 1000);
      }
      imczar = 1;
      $('#czar_results_row').show();
      if($('#draw_black_card_button').hasClass('ui-disabled'))
      {
        $("#draw_black_card_button").removeClass('ui-disabled');
      }
    }
    else
    {
      //check if it is currently displayed and if it is, turn it off
      imczar = 0;	
      $('#czar_results_row').hide();
      if(!$('#draw_black_card_button').hasClass('ui-disabled'))
      {
        $("#draw_black_card_button").addClass('ui-disabled');	
      }
    }
			
  });
}

function draw_white()
{
  $.getJSON("white_card_draw.php", {"uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid,"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid},function(data){

    jQuery.each(data, function(index, itemData) {
      $("td[name=" + index + "]").html(itemData[0].card_text);
      $("td[name=" + index + "]").attr('id', itemData[0].card_id);
    });
  });	
}

function draw_black()
{
  $.get("black_card_draw.php", {"uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid,"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid},function(data){ }); 
}

function submit_white()
{
  var cardIDString = "";
  var $i = 0;
  for (x in selectedItems)
  {
    if($i == 0)
    {
      cardIDString += selectedItems[x];
    }
    else
    {
      cardIDString += ";" + selectedItems[x];
    }
    //TODO: revisit how i do selected items
    $("#" + selectedItems[x]).html("");
    $("#" + selectedItems[x]).css("background-color","#f2f2f2");
    $("#" + selectedItems[x]).attr('id', "-1");
    $i++;
	
  }
  selectedItems.splice(0, selectedItems.length);

  $.get("submit_white_cards.php", {"uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid,"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid, "cards": cardIDString});	
  $("#submit_picks_button").addClass('ui-disabled');
}

function cleanup_current_hand()
{
  //change czar, delete from card_submit_pile update black_card_discard
  $.getJSON("cleanup_current_hand.php", {"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid},function(data){
  });
}

function pick_winner(element)
{
  $.getJSON("submit_winner.php", {"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid, "winner_id":$("#"+element.id).attr('id')},function(data){

    if (data.return_status == 'success')
    {
      cleanup_current_hand();
      $("#submitted_display").html("");
    }
  });
}

function update_score()
{
  $.getJSON("score_check.php", {"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid},function(data){ 
  var scorehtml = "<table id = 'player_score_table' data-role=\"table\" data-mode=\"columntoggle\" class= \"ui-responsvie table-stroke \"><thead><tr><th> Player </th> <th> Points </th></tr></thead><tbody>";

  jQuery.each(data,function(index,itemData) {		
		
    if(itemData.wonlast == 1)
    {
      if(itemData.czar == 1)
      {
        scorehtml += "<tr><td><b>" + index + "</b></td><td style = 'background-color: #E0E0E0'>" + itemData.score  + "</td></tr>";	
      }
      else
      {
        scorehtml += "<tr><td>" + index + "</td><td style = 'background-color: #E0E0E0'>" + itemData.score  + "</td></tr>";	
      }
    }
    else
    {
      if(itemData.czar == 1)
      {
        scorehtml += "<tr><td><b>" + index + "</b></td><td>" +  itemData.score + "</td></tr>";	
      }
      else
      {
        scorehtml += "<tr><td>" + index + "</td><td>" +  itemData.score + "</td></tr>";	
      }
    } 
  });
  scorehtml += "</tbody></table>";
  $('#player_score').html(scorehtml).trigger("create");
  });
}

function delete_cookie()
{
  $.get("quit_game.php", {"uid":jQuery.parseJSON($.cookie('cfh_cookie')).player_uid,"game_id":jQuery.parseJSON($.cookie('cfh_cookie')).game_uid});
  $.removeCookie('cfh_cookie');
  $(location).attr('href','index.html');
}


</script>

<!-- html for start of game -->
<div data-role="page" id='register'>
  <div data-role="header">
    <h1>Get Started</h1>
  </div><!-- /header -->
  <div data-role="content">	
    <form>
      <span id = 'code_enter_error_text' style = 'color:red'> </span>
      <input type="text" name="name_input" id="name_input" placeholder="Name" value="" data-clear-btn="true">
      <input type="text" name="game_id_input" id="game_id_input" placeholder="Game ID" value="" data-clear-btn="true">
      <a id='code_enter_form_submit' href="#" onclick="submitInfo()" data-role="button">Submit</a>
      <!--<a id='create_new_game' href="create_game.php" data-role="button" data-rel="dialog" >Create New Game</a> -->
      <a id='create_new_game' href="#redraw_allow" data-role="button" data-rel="dialog" >Create New Game</a>
    </form>
  </div> <!-- /content -->
</div>
<div data-role="page" id='redraw_allow'>
  <div data-role="header">
    <h1> Redraws to allow </h1>
  </div> <!-- /header -->
  <div data-role="content">
    <form>
      # of White Card Redraws to allow
      <input type="number" min="0" max="30" name="redraw_input" id="redraw_input" value="5" data-clr-btn="true"/>
      <a href="#" onclick="redraw_submit()" id='redraw_submit' data-role="button" data-rel="dialog">Submit</a>
    </form>
  </div>
</div>
<!-- /html for start of game -->

<!-- html for main area of game -->
<div data-role="page" id='main'>
  <div data-role="header">
    <h1><div id='main_page_header'></div></h1>
  </div><!-- /header -->

  <div data-role="content">
    <div id = 'player_score'>
    </div>
    <table id = 'main_board' style = 'width:100%'>
      <tr id = 'black_section_row'>
        <td>
              <table id = 'black_section'>
	        <tr><td style = 'height:160px; width: 130px;padding:10px;vertical-align: top; border-style: solid; border-width:3px; background-color: black; color: white' name = 'black_card_contents' id = 'black_id_-1'> </td>
	 	    <td> <a href="#"  onclick = 'draw_black()' id = 'draw_black_card_button' class = 'ui-disabled' data-role="button">Draw</a></td>
		</tr>
          </table><br/><br/>
        </td></tr>
      <tr style =  'display: none' id = 'czar_results_row'>
	<td colspan = 2>
	  <table id = 'czar_results_section' width = '100%'>
 	    <tr>
	      <td> Players left to submit: <span id ='submitted_player_count'> </span></td>
	    </tr>
	    <tr>
	      <td id = 'submitted_display'> </td>
            </tr>
	  </table>
	  <br/><br/><br/>
        </td>
      </tr>
      <tr>
        <td>
          Redraws Reamining: <span id='redraws_remaining'> </span>
          <a href="#" id = 'submit_picks_button' name = 'submit_picks_button' data-role='button' onclick = 'submit_white()' class='ui-disabled'> Submit</a>
          <a href="#" id = 'draw_white_card' name = 'draw_white_card' data-role='button' onclick = 'draw_white()'> Draw </a>
	 </td>
      </tr>
      <tr id = 'white_section_row'>
       <td>
         <table id = 'white_section' style='width:100%'>
	   <tr>
	     <td  onclick = 'card_select(this)' name = '1_white_card_contents' style = 'padding: 10px; vertical-align:top; border-style: solid; border-width:3px' id = '-1'>  
             </td>
	     <td onclick = 'card_select(this)'  name = '2_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
	     <td onclick = 'card_select(this)'  name = '3_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
             </td>
	     <td onclick = 'card_select(this)'  name = '4_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
          </tr>
          <tr>
	     <td onclick = 'card_select(this)'  name = '5_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
    	     <td onclick = 'card_select(this)'  name = '6_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
             </td>
	     <td onclick = 'card_select(this)'  name = '7_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
	     <td onclick = 'card_select(this)'  name = '8_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
           </tr>
           <tr>
	     <td onclick = 'card_select(this)'  name = '9_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
	     </td>
	     <td  onclick = 'card_select(this)'  name = '10_white_card_contents' style = 'height:160px; width: 130px; padding: 10px; vertical-align:top;  border-style: solid; border-width:3px' id = '-1'> 
             </td>
           </tr>
         </table> 
      </td>
    </tr>
     </table> 
     <br/><br/>
     <a href="#" id='quit_game' onclick="delete_cookie()" data-role="button">Quit Game</a>
   </div><!-- /content -->
  </div><!-- /html for main area of game -->
</body>
</html>
